id: ai-pull-request-analysis
namespace: devplus

inputs:
  - name: pr_id
    type: STRING
  - name: pr_number
    type: INT
  - name: repo_id
    type: STRING
  - name: pr_title
    type: STRING
  - name: callback_url
    type: STRING

tasks:
  - id: fetch_diff
    type: io.kestra.plugin.scripts.shell.Commands
    runner: PROCESS
    commands:
      - echo "Fetching diff for Repo {{ inputs.repo_id }} PR {{ inputs.pr_id }}..."
      # TODO: Replace with GitHub API diff fetch

  - id: analyze_with_gemini
    type: io.kestra.plugin.gemini.ChatCompletion
    apiKey: "{{ secret('GEMINI_API_KEY') }}"
    model: gemini-pro
    messages:
      - role: user
        content: |
          You are a code reviewer. Analyze the following Pull Request:
          PR Title: {{ inputs.pr_title }}

          Provide a JSON response in the format:
          {
            "summary": "...",
            "decision": "APPROVE or REQUEST_CHANGES"
          }

  - id: callback_backend
    type: io.kestra.plugin.core.http.Request
    uri: "{{ inputs.callback_url }}"
    method: POST
    contentType: application/json
    body: |
      {
        "pr_id": "{{ inputs.pr_id }}",
        "summary": "{{ outputs.analyze_with_gemini.result | jq('.summary') }}",
        "decision": "{{ outputs.analyze_with_gemini.result | jq('.decision') }}"
      }
